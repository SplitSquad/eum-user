<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>OAuth í…ŒìŠ¤íŠ¸</title>
    <style>
        .btn {
            padding: 10px 20px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        .login {
            background-color: #34a853;
            color: white;
        }
        .logout {
            background-color: #db4437;
            color: white;
        }
        .info {
            background-color: #4285f4;
            color: white;
        }
        .lang {
            background-color: #fbbc05;
            color: white;
        }
    </style>
</head>
<body>

<!-- ë¡œê·¸ì¸ ë²„íŠ¼ -->
<button class="btn login" onclick="goToGoogleLogin()">Google ë¡œê·¸ì¸</button>

<!-- ë‚´ ì •ë³´ ë²„íŠ¼ -->
<button class="btn info" onclick="window.location.href='profile.html'">ë‚´ ì •ë³´</button>

<!-- ìº˜ë¦°ë” ì¡°íšŒ ë²„íŠ¼ -->
<button class="btn info" onclick="getCalendarEvents()">ğŸ“… ë‚´ ìº˜ë¦°ë” ì¼ì • ë³´ê¸°</button>

<!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
<button class="btn logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>

<!-- íšŒì› íƒˆí‡´ ë²„íŠ¼ -->
<button class="btn logout" onclick="deleteUser()">íšŒì› íƒˆí‡´</button>

<!-- ì–¸ì–´ ì„¤ì • ë²„íŠ¼ -->
<button class="btn lang" onclick="setLanguage('KR')">í•œêµ­ì–´</button>
<button class="btn lang" onclick="setLanguage('EN')">English</button>

<pre id="result"></pre>

<script>
    const API_BASE_URL = 'http://localhost:8080';
    let isLoginRequestInProgress = false;

    async function goToGoogleLogin() {
        if (isLoginRequestInProgress) return;

        try {
            isLoginRequestInProgress = true;
            const res = await fetch(`${API_BASE_URL}/auth/url`);
            if (!res.ok) throw new Error('êµ¬ê¸€ ë¡œê·¸ì¸ URL ìš”ì²­ ì‹¤íŒ¨');
            const data = await res.json();
            window.location.href = data.authUrl;
        } catch (e) {
            alert('âš ï¸ ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + e.message);
        } finally {
            isLoginRequestInProgress = false;
        }
    }

    async function getCalendarEvents() {
        try {
            const accessToken = sessionStorage.getItem('accessToken');
            if (!accessToken) throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');

            const res = await fetch(`${API_BASE_URL}/calendar/events`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${accessToken}`
                }
            });

            if (!res.ok) throw new Error('ì¼ì • ì¡°íšŒ ì‹¤íŒ¨ (' + res.status + ')');

            const data = await res.json();
            document.getElementById("result").textContent = JSON.stringify(data, null, 2);
        } catch (e) {
            alert('âš ï¸ ' + e.message);
        }
    }

    async function deleteUser() {
        if (!confirm("ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const accessToken = sessionStorage.getItem('accessToken');
        if (!accessToken) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
            return;
        }

        const res = await fetch(`${API_BASE_URL}/auth/delete`, {
            method: "DELETE",
            headers: {
                "Authorization": `Bearer ${accessToken}`
            }
        });

        if (res.ok) {
            sessionStorage.removeItem('accessToken');
            alert("ğŸ—‘ï¸ íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤");
            location.reload();
        } else {
            alert("âŒ íƒˆí‡´ ì‹¤íŒ¨");
        }
    }

    async function logout() {
        const accessToken = sessionStorage.getItem('accessToken');
        if (!accessToken) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
            return;
        }

        await fetch(`${API_BASE_URL}/auth/logout`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${accessToken}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ token: "" })
        });

        sessionStorage.removeItem('accessToken');
        alert("ğŸ”’ ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ");
        location.reload();
    }

    async function setLanguage(langCode) {
        try {
            const accessToken = sessionStorage.getItem('accessToken');
            if (!accessToken) throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');

            const res = await fetch(`${API_BASE_URL}/users/profile/language`, {
                method: "PUT",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ language: langCode })
            });

            if (!res.ok) throw new Error('ì–¸ì–´ ì„¤ì • ì‹¤íŒ¨ (' + res.status + ')');
            alert(`ğŸŒ ì–¸ì–´ê°€ ${langCode}ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } catch (e) {
            alert('âš ï¸ ' + e.message);
        }
    }
</script>

<script>
    window.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');

        if (code) {
            try {
                const res = await fetch(`${API_BASE_URL}/auth/login?code=${code}`, {
                    credentials: 'include'
                });
                if (!res.ok) throw new Error("AccessToken ë°œê¸‰ ì‹¤íŒ¨");

                const accessToken = res.headers.get('Authorization');
                if (!accessToken) {
                    throw new Error("Authorization í—¤ë” ì—†ìŒ");
                }

                sessionStorage.setItem("accessToken", accessToken); // âœ… ì„¸ì…˜ì— ì €ì¥
                localStorage.setItem("accessToken", accessToken);
                console.log("âœ… AccessToken ì €ì¥ ì™„ë£Œ:", accessToken);

                window.history.replaceState({}, document.title, "/index.html"); // ğŸ‘ˆ ì£¼ì†Œì°½ì—ì„œ ?code= ì œê±°
            } catch (e) {
                alert('âŒ ë¡œê·¸ì¸ ì²˜ë¦¬ ì‹¤íŒ¨: ' + e.message);
            }
        }
    });
</script>

</body>
</html>
